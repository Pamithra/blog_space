<?php require_once __DIR__ . '/../inc/config.php'; require_once __DIR__ . '/../inc/db.php'; require_once __DIR__ . '/../inc/helpers.php'; if (!is_logged_in()){ $_SESSION['flash']='Login required'; header('Location: '.BASE_URL.'auth/login.php'); exit; } $cats = $pdo->query('SELECT * FROM category ORDER BY name')->fetchAll(); if ($_SERVER['REQUEST_METHOD'] === 'POST') { if (!csrf_verify($_POST['_csrf'] ?? '')){ $_SESSION['flash']='Invalid'; header('Location: '.BASE_URL.'posts/new.php'); exit; } $title = trim($_POST['title'] ?? ''); $content = trim($_POST['content'] ?? ''); $category_id = !empty($_POST['category_id']) ? (int)$_POST['category_id'] : null; $tags_raw = trim($_POST['tags'] ?? ''); if (!$title || !$content){ $_SESSION['flash']='Title and content required'; header('Location: '.BASE_URL.'posts/new.php'); exit; } $img = save_uploaded_image('image','post'); $stmt = $pdo->prepare('INSERT INTO blogPost (user_id, category_id, title, content, image) VALUES (:uid,:cid,:t,:c,:img)'); $stmt->execute([':uid'=>$_SESSION['user']['id'],':cid'=>$category_id,':t'=>$title,':c'=>$content,':img'=>$img]); $post_id = $pdo->lastInsertId(); if ($tags_raw !== '') { $tags = array_unique(array_filter(array_map('trim', explode(',', $tags_raw)))); $sel = $pdo->prepare('SELECT id FROM tag WHERE name = :name LIMIT 1'); $ins = $pdo->prepare('INSERT INTO tag (name) VALUES (:name)'); $link = $pdo->prepare('INSERT INTO post_tag (post_id, tag_id) VALUES (:pid, :tid)'); foreach ($tags as $t) { if ($t === '') continue; $sel->execute([':name'=>$t]); $r = $sel->fetch(); if ($r) $tid = $r['id']; else { $ins->execute([':name'=>$t]); $tid = $pdo->lastInsertId(); } $link->execute([':pid'=>$post_id,':tid'=>$tid]); } } $_SESSION['flash']='Post created'; header('Location: '.BASE_URL.'posts/view.php?id='.$post_id); exit; } require_once __DIR__ . '/../inc/header.php'; ?><h1>New Post</h1><form method="post" enctype="multipart/form-data" class="form"><input type="hidden" name="_csrf" value="<?php echo csrf_token(); ?>"><label>Title <input name="title" required></label><label>Category <select name="category_id"><option value="">--None--</option><?php foreach($cats as $c): ?><option value="<?php echo $c['id'];?>"><?php echo htmlspecialchars($c['name']);?></option><?php endforeach;?></select></label><label>Tags (comma separated) <input name="tags" placeholder="php, web"></label><label>Featured image <input type="file" name="image" accept="image/*"></label><label>Content <textarea name="content" rows="10" required></textarea></label><button type="submit">Publish</button></form><?php require_once __DIR__ . '/../inc/footer.php'; ?>